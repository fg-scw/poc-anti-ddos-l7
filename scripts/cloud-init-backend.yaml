#cloud-config
# Cloud-init pour Backend Demo (Nginx)
# POC Anti-DDoS Layer 7

package_update: true
package_upgrade: true

packages:
  - nginx
  - curl

write_files:
  # Page HTML de demo
  - path: /var/www/html/index.html
    permissions: '0644'
    content: |
      <!DOCTYPE html>
      <html lang="fr">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>POC Anti-DDoS L7 - Backend ${backend_index}</title>
          <style>
              body {
                  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  min-height: 100vh;
                  margin: 0;
                  display: flex;
                  justify-content: center;
                  align-items: center;
              }
              .container {
                  background: white;
                  padding: 40px;
                  border-radius: 10px;
                  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                  text-align: center;
                  max-width: 600px;
              }
              h1 {
                  color: #333;
                  margin-bottom: 10px;
              }
              .server-info {
                  background: #f5f5f5;
                  padding: 20px;
                  border-radius: 5px;
                  margin: 20px 0;
              }
              .server-info p {
                  margin: 10px 0;
                  font-family: monospace;
              }
              .status {
                  display: inline-block;
                  padding: 5px 15px;
                  background: #4CAF50;
                  color: white;
                  border-radius: 20px;
                  font-weight: bold;
              }
              .badge {
                  display: inline-block;
                  padding: 3px 10px;
                  background: #2196F3;
                  color: white;
                  border-radius: 3px;
                  margin: 5px;
                  font-size: 12px;
              }
          </style>
      </head>
      <body>
          <div class="container">
              <h1>[SHIELD] POC Anti-DDoS Layer 7</h1>
              <p class="status">Backend #${backend_index} Operationnel</p>
              
              <div class="server-info">
                  <p><strong>Hostname:</strong> <span id="hostname"></span></p>
                  <p><strong>Timestamp:</strong> <span id="timestamp"></span></p>
                  <p><strong>Request ID:</strong> <span id="request-id"></span></p>
              </div>
              
              <div>
                  <span class="badge">HAProxy</span>
                  <span class="badge">CrowdSec</span>
                  <span class="badge">GeoIP</span>
                  <span class="badge">Rate Limiting</span>
              </div>
              
              <p style="margin-top: 20px; color: #666; font-size: 14px;">
                  Cette page est servie depuis le backend #${backend_index}<br>
                  derriere la stack HAProxy + CrowdSec
              </p>
          </div>
          
          <script>
              document.getElementById('hostname').textContent = 'backend-${backend_index}';
              document.getElementById('timestamp').textContent = new Date().toISOString();
              document.getElementById('request-id').textContent = Math.random().toString(36).substr(2, 9);
          </script>
      </body>
      </html>

  # Endpoint de health check
  - path: /var/www/html/health
    permissions: '0644'
    content: |
      OK

  # Endpoint API de test
  - path: /var/www/html/api/status
    permissions: '0644'
    content: |
      {
        "status": "healthy",
        "backend": ${backend_index},
        "version": "1.0.0",
        "timestamp": "2024-01-01T00:00:00Z"
      }

  # Configuration Nginx
  - path: /etc/nginx/sites-available/default
    permissions: '0644'
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          
          root /var/www/html;
          index index.html;
          
          server_name _;
          
          # Health check endpoint
          location = /health {
              access_log off;
              return 200 "OK\n";
              add_header Content-Type text/plain;
          }
          
          # API status endpoint
          location /api/status {
              default_type application/json;
              return 200 '{"status":"healthy","backend":${backend_index},"timestamp":"$time_iso8601"}';
          }
          
          # Headers pour identifier le backend
          location / {
              add_header X-Backend-Server "backend-${backend_index}";
              add_header X-Served-By "$hostname";
              try_files $uri $uri/ =404;
          }
          
          # Logging
          access_log /var/log/nginx/access.log;
          error_log /var/log/nginx/error.log;
      }

runcmd:
  # Activation de la configuration
  - systemctl enable nginx
  - systemctl restart nginx
  
  # Log de fin d'installation
  - echo "Backend ${backend_index} pret" | tee /var/log/cloud-init-complete.log
  - date >> /var/log/cloud-init-complete.log

final_message: "Backend ${backend_index} pret apres $${UPTIME} secondes"
